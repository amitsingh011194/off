#!/bin/bash

main(){
    source /root/.bashrc
    source ~/.nvm/nvm.sh
    APP_NAME="pos-app-api-TARGET_ENV"
    APP_DIR="/opt/project/sources/$APP_NAME"
    ENV_FILE=".env"
    TEMP_FILE="/tmp/temp_TARGET_ENV"

    echo "Switching to app directory: $APP_DIR"
    cd "$APP_DIR" || { echo "ERROR: Directory $APP_DIR does not exist"; exit 1; }
    sleep 100

    if [ ! -f "$TEMP_FILE" ]; then
        echo "ERROR: Temp .env file not found at $TEMP_FILE"
        exit 1
    fi

    if [ ! -f "version.txt" ]; then
        echo "ERROR: version.txt not found."
        exit 1
    fi

    NEW_VERSION=$(cat version.txt)
    mv "$TEMP_FILE" "$ENV_FILE"

    sed -i "s/NEXT_PUBLIC_SSP_UI_FNBO_BE_BUILD_NUMBER=.*/NEXT_PUBLIC_SSP_UI_FNBO_BE_BUILD_NUMBER=$NEW_VERSION/g" "$ENV_FILE"

    echo "Current directory: $(pwd)"
    ls -al

    nvm use 18

    if [ ! -f "package.json" ]; then
        echo "ERROR: package.json not found. Exiting."
        exit 1
    fi

    npm install || {
