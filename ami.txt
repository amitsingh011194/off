#!/bin/bash

# Move .env file back into correct place then start app
main(){

    export PATH=$PATH:/root/.nvm/versions/node/v18.14.0/bin/
    export NVM_BIN=/root/.nvm/versions/node/v18.14.0/bin
    export NVM_DIR=/root/.nvm
    export NVM_INC=/root/.nvm/versions/node/v18.14.0/include/node
    source $NVM_DIR/nvm.sh
    APP_NAME="pos-app-ui-TARGET_ENV"
    cd /opt/project/sources/$APP_NAME/
    ENV_FILE=".env.local"
    TEMP_FILE="/tmp/temp_TARGET_ENV"
    echo "************ ENV***********"
    env 
    echo "************ ENV finish ***********"
    echo $PATH
    echo "************ PATH finish ***********"
    VERSION_VARIABLE="NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER="

    NEW_VERSION=$(cat version.txt)
    mv $TEMP_FILE /opt/project/sources/$APP_NAME/$ENV_FILE

    sed -i "s/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=.*/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=$NEW_VERSION/g" $ENV_FILE

    # sed -i "s/$VERSION_VARIABLE.*/$VERSION_VARIABLE$NEW_VERSION/g" $ENV_FILE

    rm -rf node_modules
    ls
    # echo "************ yarn***********"
    yarn
    # echo "************ yarn run Build***********"
    yarn run build
    # yarn install 
    # echo "************ yarn Build finish ***********"
    # yarn build
    echo "******** pm2 start ************"
    pm2 restart $(echo ${APP_NAME}|tr [:lower:] [:upper:]) --update-env
    ls
    echo "******** pm2 FINISHED ************"
}

main


=====================================

#!/bin/bash

main(){

    export PATH=$PATH:/root/.nvm/versions/node/v18.14.0/bin/
    export NVM_BIN=/root/.nvm/versions/node/v18.14.0/bin
    export NVM_DIR=/root/.nvm
    export NVM_INC=/root/.nvm/versions/node/v18.14.0/include/node
    source $NVM_DIR/nvm.sh

    APP_NAME="pos-app-ui-af1"
    APP_DIR="/opt/project/sources/$APP_NAME"
    ENV_FILE=".env.local"
    TEMP_FILE="/tmp/temp_af1"

    echo "Switching to app directory: $APP_DIR"
    cd "$APP_DIR" || { echo "ERROR: Directory $APP_DIR does not exist"; exit 1; }

    if [ ! -f "$TEMP_FILE" ]; then
        echo "ERROR: Temp .env file not found at $TEMP_FILE"
        exit 1
    fi

    if [ ! -f "version.txt" ]; then
        echo "ERROR: version.txt not found."
        exit 1
    fi

    NEW_VERSION=$(cat version.txt)
    mv "$TEMP_FILE" "$ENV_FILE"

    sed -i "s/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=.*/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=$NEW_VERSION/g" "$ENV_FILE"

    echo "Current directory: $(pwd)"
    ls -al

    yarn install || { echo "yarn install failed"; exit 1; }
    yarn run build || { echo "yarn build failed"; exit 1; }

    echo "Starting app with pm2..."
    pm2 restart "$(echo ${APP_NAME} | tr '[:lower:]' '[:upper:]')" --update-env || {
        echo "pm2 restart failed"; exit 1;
    }

    echo "Deployment finished successfully."
}

main

------------


#!/bin/bash

# Move .env file to temporary location for install

main(){
    unset $APP_NAME
    APP_NAME="pos-app-ui-TARGET_ENV"
    ENV_FILE=".env.local"
    TEMP_FILE="/tmp/temp_TARGET_ENV"

    mv /opt/project/sources/$APP_NAME/$ENV_FILE $TEMP_FILE

    rm -rf src public
 
}

main


#!/bin/bash

# Move .env file to temporary location for install

main(){
    APP_NAME="pos-app-ui-af1"
    ENV_FILE=".env.local"
    TEMP_FILE="/tmp/temp_af1"

    echo "Moving $ENV_FILE to $TEMP_FILE"
    mv /opt/project/sources/$APP_NAME/$ENV_FILE $TEMP_FILE || {
        echo "ERROR: Failed to move $ENV_FILE to $TEMP_FILE"; exit 1;
    }

    echo "Cleaning up old src and public directories..."
    rm -rf /opt/project/sources/$APP_NAME/src /opt/project/sources/$APP_NAME/public
}

main



