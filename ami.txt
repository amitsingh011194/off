#!/bin/bash

main(){
    export PATH=$PATH:/root/.nvm/versions/node/v18.14.0/bin/
    export NVM_BIN=/root/.nvm/versions/node/v18.14.0/bin
    export NVM_DIR=/root/.nvm
    export NVM_INC=/root/.nvm/versions/node/v18.14.0/include/node
    source $NVM_DIR/nvm.sh

    APP_NAME="pos-app-ui-TARGET_ENV"
    APP_DIR="/opt/project/sources/$APP_NAME"
    ENV_FILE=".env.local"
    TEMP_FILE="/tmp/temp_TARGET_ENV"

    echo "Switching to app directory: $APP_DIR"
    cd "$APP_DIR" || { echo "ERROR: Directory $APP_DIR does not exist"; exit 1; }

    if [ ! -f "$TEMP_FILE" ]; then
        echo "ERROR: Temp .env file not found at $TEMP_FILE"
        exit 1
    fi

    if [ ! -f "version.txt" ]; then
        echo "ERROR: version.txt not found."
        exit 1
    fi

    NEW_VERSION=$(cat version.txt)
    mv "$TEMP_FILE" "$ENV_FILE"

    sed -i "s/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=.*/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=$NEW_VERSION/g" "$ENV_FILE"

    echo "Current directory: $(pwd)"
    ls -al

    yarn install || { echo "yarn install failed"; exit 1; }
    yarn run build || { echo "yarn build failed"; exit 1; }

    PM2_NAME=$(echo "${APP_NAME}" | tr '[:lower:]' '[:upper:]')
    pm2 start yarn --name "$PM2_NAME" -- run start --update-env || {
        echo "pm2 start failed"; exit 1;
    }

    echo "Deployment finished successfully."
}

main


 sudo su -
root@EC3-B17-DSP1FE:~# pm2 list
┌─────┬─────────────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id  │ name                │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├─────┼─────────────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 0   │ POS-APP-API         │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 11  │ POS-APP-API-AF1     │ default     │ 0.39.7  │ fork    │ 0        │ 0      │ 27   │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 20  │ POS-APP-API-AF1     │ default     │ 0.39.7  │ fork    │ 0        │ 0      │ 10   │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 13  │ POS-APP-API-AF2     │ default     │ 0.39.7  │ fork    │ 1519     │ 2D     │ 0    │ online    │ 0%       │ 51.2mb   │ root     │ disabled │
│ 2   │ POS-APP-API-CICD    │ default     │ N/A     │ fork    │ N/A      │ 0      │ 1782 │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 3   │ POS-APP-API-DEV3    │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 4   │ POS-APP-API-DEV4    │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 5   │ POS-APP-API-DEV5    │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 18  │ POS-APP-API-UCL1    │ default     │ 0.39.7  │ fork    │ 1583     │ 2D     │ 0    │ online    │ 0%       │ 51.1mb   │ root     │ disabled │
│ 15  │ POS-APP-API-UCL2    │ default     │ 0.39.7  │ fork    │ 0        │ 0      │ 3660 │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 6   │ POS-APP-UI          │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 22  │ POS-APP-UI-AF1      │ default     │ N/A     │ fork    │ 0        │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 23  │ POS-APP-UI-AF1      │ default     │ N/A     │ fork    │ 1296563  │ 65m    │ 0    │ online    │ 0%       │ 72.4mb   │ root     │ disabled │
│ 14  │ POS-APP-UI-AF2      │ default     │ 0.39.7  │ fork    │ 1522     │ 2D     │ 0    │ online    │ 0%       │ 51.0mb   │ root     │ disabled │
│ 10  │ POS-APP-UI-CICD     │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 7   │ POS-APP-UI-DEV3     │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 8   │ POS-APP-UI-DEV4     │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 9   │ POS-APP-UI-DEV5     │ default     │ N/A     │ fork    │ N/A      │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 16  │ POS-APP-UI-UCL1     │ default     │ 0.39.7  │ fork    │ 1556     │ 2D     │ 0    │ online    │ 0%       │ 50.9mb   │ root     │ disabled │
│ 17  │ POS-APP-UI-UCL2     │ default     │ 0.39.7  │ fork    │ 0        │ 0      │ 983  │ stopped   │ 0%       │ 0b       │ root     │ disabled │
│ 1   │ POS-APP-UI-V3       │ default     │ N/A     │ fork    │ 0        │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ root     │ disabled │
└─────┴─────────────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
[PM2][WARN] Current process list is not synchronized with saved list. Type 'pm2 save' to synchronize.
root@EC3-B17-DSP1FE:~#


