#!/bin/bash

main() {
    TARGET_ENV=$1
    if [ -z "$TARGET_ENV" ]; then
        echo "ERROR: TARGET_ENV not passed"
        exit 1
    fi

    export PATH=$PATH:/root/.nvm/versions/node/v18.14.0/bin/
    export NVM_BIN=/root/.nvm/versions/node/v18.14.0/bin
    export NVM_DIR=/root/.nvm
    source $NVM_DIR/nvm.sh

    APP_NAME="pos-app-ui-${TARGET_ENV}"
    APP_DIR="/opt/project/sources/${APP_NAME}"
    ENV_FILE=".env.local"
    TEMP_FILE="/tmp/temp_${TARGET_ENV}"
    PM2_NAME="$(echo ${APP_NAME} | tr '[:lower:]' '[:upper:]')"

    echo "Switching to app directory: $APP_DIR"
    cd "$APP_DIR" || { echo "ERROR: Directory $APP_DIR does not exist"; exit 1; }

    if [ ! -f "$TEMP_FILE" ]; then
        echo "ERROR: Temp .env file not found at $TEMP_FILE"
        exit 1
    fi

    if [ ! -f "version.txt" ]; then
        echo "ERROR: version.txt not found."
        exit 1
    fi

    NEW_VERSION=$(cat version.txt)
    mv "$TEMP_FILE" "$ENV_FILE"
    sed -i "s/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=.*/NEXT_PUBLIC_SSP_UI_FNBO_FE_BUILD_NUMBER=$NEW_VERSION/g" "$ENV_FILE"

    yarn install || { echo "yarn install failed"; exit 1; }
    yarn run build || { echo "yarn build failed"; exit 1; }

    echo "Restarting app with PM2..."
    pm2 delete "$PM2_NAME" || true
    pm2 start yarn --name "$PM2_NAME" -- run start || {
        echo "pm2 start failed"; exit 1;
    }
    pm2 save

    echo "Deployment finished successfully for $PM2_NAME"
}

main "$@"
